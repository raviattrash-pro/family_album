<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Floral Musical 3D Album</title>
    
    <script src="https://cdn.jsdelivr.net/npm/page-flip/dist/js/page-flip.browser.js"></script>

    <style>
        :root {
            --soft-pink: #fce4ec;
            --deep-rose: #880e4f;
            --glass: rgba(255, 255, 255, 0.7);
        }

        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            overflow: hidden;
            font-family: 'Georgia', serif;
            background: url('https://images.unsplash.com/photo-1526047932273-341f2a7631f9?auto=format&fit=crop&w=1920&q=80');
            background-size: cover;
            background-position: center;
        }

        #interactive-bg {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(2px);
            z-index: -1;
            transition: transform 0.1s ease-out;
        }

        /* UI Controls */
        .controls {
            position: absolute;
            top: 25px;
            width: 100%;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            z-index: 1000;
        }

        .btn {
            background: var(--glass);
            color: var(--deep-rose);
            padding: 10px 20px;
            border: 2px solid var(--deep-rose);
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover { background: var(--deep-rose); color: white; }
        .btn-active { background: #2ecc71 !important; color: white !important; border-color: #27ae60 !important; }

        input[type="file"] { display: none; }

        /* Album Viewport */
        .viewport {
            width: 100%; height: 100vh;
            display: flex; justify-content: center; align-items: center;
        }

        #book { visibility: hidden; filter: drop-shadow(0 20px 40px rgba(0,0,0,0.3)); }
        .page { background: #fff; }
        .page-content { width: 100%; height: 100%; position: relative; }
        .page-content img { width: 100%; height: 100%; object-fit: cover; border: 8px solid white; box-sizing: border-box; }

        .page-cover {
            background: var(--soft-pink);
            color: var(--deep-rose);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            text-align: center; border: 10px double var(--deep-rose);
        }

        .status-text {
            position: absolute; top: 60%; width: 100%;
            text-align: center; color: var(--deep-rose); font-style: italic;
        }

        /* Music Visualization */
        .music-note {
            font-size: 12px;
            animation: float 3s infinite ease-in-out;
        }
        @keyframes float {
            0% { transform: translateY(0px); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(-20px); opacity: 0; }
        }
    </style>
</head>
<body>

    <div id="interactive-bg"></div>

    <div class="controls">
        <label class="btn">
            ✿ Add Photos
            <input type="file" id="imageInput" accept="image/*" multiple>
        </label>
        
        <label class="btn">
            ♫ Add Music
            <input type="file" id="musicInput" accept="audio/*">
        </label>

        <button class="btn" id="musicToggleBtn" style="display:none;">Play Music</button>
        <button class="btn" id="autoPlayBtn">▶ Auto Play</button>
        <button class="btn" id="clearBtn" style="border-color: #ff4757; color: #ff4757;">Clear</button>
    </div>

    <div id="loading" class="status-text">Your musical album is empty. Please upload photos and music.</div>

    <div class="viewport">
        <div id="book">
            <div class="page page-cover" data-density="hard">
                <h1 style="font-size: 2.5rem; margin: 0;">Our Musical Story</h1>
                <p>Drag corners to turn pages</p>
                <div id="visualizer"></div>
            </div>
            <div class="page page-cover" data-density="hard" id="back-cover">
                <h2>The End</h2>
                <p>Forever & Always</p>
            </div>
        </div>
    </div>

    <audio id="albumMusic" loop></audio>

    <script>
        const bg = document.getElementById('interactive-bg');
        const musicInput = document.getElementById('musicInput');
        const audio = document.getElementById('albumMusic');
        const musicToggleBtn = document.getElementById('musicToggleBtn');
        
        // INTERACTIVE BACKGROUND
        window.addEventListener('mousemove', (e) => {
            const moveX = (e.clientX - window.innerWidth / 2) / 50;
            const moveY = (e.clientY - window.innerHeight / 2) / 50;
            bg.style.transform = `scale(1.1) translate(${moveX}px, ${moveY}px)`;
        });

        // MUSIC LOGIC
        musicInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                audio.src = url;
                musicToggleBtn.style.display = 'flex';
                musicToggleBtn.innerText = "▶ Play Music";
                
                // Automatically save music to IndexedDB (Optional but complex for large files)
                // For now, we use the local blob URL
            }
        });

        musicToggleBtn.onclick = function() {
            if (audio.paused) {
                audio.play();
                this.innerText = "⏸ Pause Music";
                this.classList.add('btn-active');
            } else {
                audio.pause();
                this.innerText = "▶ Play Music";
                this.classList.remove('btn-active');
            }
        };

        /** ALBUM ENGINE **/
        let flipBook = null;
        let playInterval = null;
        const DB_NAME = "MusicalFloralDB";

        async function initDB() {
            return new Promise((resolve) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onupgradeneeded = (e) => e.target.result.createObjectStore("images", { autoIncrement: true });
                request.onsuccess = (e) => resolve(e.target.result);
            });
        }

        async function saveImage(data) {
            const db = await initDB();
            const tx = db.transaction("images", "readwrite");
            tx.objectStore("images").add(data);
        }

        async function loadImages() {
            const db = await initDB();
            if (!db.objectStoreNames.contains("images")) return [];
            return new Promise((resolve) => {
                const tx = db.transaction("images", "readonly");
                tx.objectStore("images").getAll().onsuccess = (e) => resolve(e.target.result);
            });
        }

        document.getElementById('imageInput').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            document.getElementById('loading').innerText = "Processing your memories...";
            for (const file of files) {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                await new Promise(r => reader.onload = async (ev) => {
                    await saveImage(ev.target.result);
                    r();
                });
            }
            location.reload();
        });

        document.getElementById('clearBtn').onclick = () => {
            indexedDB.deleteDatabase(DB_NAME);
            location.reload();
        };

        document.getElementById('autoPlayBtn').onclick = function() {
            if (playInterval) {
                clearInterval(playInterval);
                playInterval = null;
                this.innerText = "▶ Auto Play";
                this.classList.remove('btn-active');
            } else {
                if (!flipBook) return;
                this.innerText = "⏸ Playing";
                this.classList.add('btn-active');
                playInterval = setInterval(() => {
                    if (flipBook.getPageCount() - 1 === flipBook.getCurrentPageIndex()) {
                        flipBook.turnToPage(0);
                    } else {
                        flipBook.flipNext();
                    }
                }, 3500);
            }
        };

        async function renderBook() {
            const images = await loadImages();
            if (images.length === 0) return;

            const bookDiv = document.getElementById('book');
            const backCover = document.getElementById('back-cover');
            document.getElementById('loading').style.display = 'none';

            images.forEach((src) => {
                const page = document.createElement('div');
                page.className = 'page';
                page.innerHTML = `<div class="page-content"><img src="${src}"></div>`;
                bookDiv.insertBefore(page, backCover);
            });

            flipBook = new St.PageFlip(bookDiv, {
                width: 450, height: 600,
                size: "stretch",
                showCover: true,
                maxShadowOpacity: 0.5
            });

            flipBook.loadFromHTML(document.querySelectorAll('.page'));
            bookDiv.style.visibility = 'visible';

            // Add sound effect on page turn
            flipBook.on('flip', () => {
                const flipSound = new Audio('https://www.soundjay.com/misc/sounds/page-flip-01a.mp3');
                flipSound.volume = 0.3;
                flipSound.play().catch(() => {}); // Catch browser blocking audio
            });
        }

        renderBook();
    </script>
</body>
</html>